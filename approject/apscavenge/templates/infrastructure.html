{% extends "layout-nav.html" %}
{% load static %}

{% block custom_stylesheet %}
<link rel="stylesheet" href="{% static 'css/infrastructure.css' %}">
{% endblock %}

{% block title_ext %}Infrastructure - {% endblock %}

{% block main_class %} class="mt-5 mb-5"{% endblock %}

{% block content %}

<div class="page-indicator">APScavenge <b>> <span class="underlined mb-5">Infrastructure</b></span></div>

{% include "infrastructure_grid.html" %}

{% if agentstatus_objects|length == 0 %}
<div class="center">
    <svg class="mb-4" fill="#ef9a38" width="70" aria-hidden="true" focusable="false" data-prefix="fal" data-icon="info-circle" class="svg-inline--fa fa-info-circle fa-w-16 " role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path d="M256 40c118.621 0 216 96.075 216 216 0 119.291-96.61 216-216 216-119.244 0-216-96.562-216-216 0-119.203 96.602-216 216-216m0-32C119.043 8 8 119.083 8 256c0 136.997 111.043 248 248 248s248-111.003 248-248C504 119.083 392.957 8 256 8zm-36 344h12V232h-12c-6.627 0-12-5.373-12-12v-8c0-6.627 5.373-12 12-12h48c6.627 0 12 5.373 12 12v140h12c6.627 0 12 5.373 12 12v8c0 6.627-5.373 12-12 12h-72c-6.627 0-12-5.373-12-12v-8c0-6.627 5.373-12 12-12zm36-240c-17.673 0-32 14.327-32 32s14.327 32 32 32 32-14.327 32-32-14.327-32-32-32z"></path></svg>
    <h5>No agents online</h5>
</div>
{% endif %}

<script type="text/javascript">
    function submitGridForm(agentAction) {
        let csrf_token = $('[name="csrfmiddlewaretoken"]').val();   // Include CSRF token in AJAX request headers
        let formData = $('#infrastructure-grid-form').serialize();  // Serialize form data
        formData += '&ajaxGridUpdate=' + encodeURIComponent('True');

        formData += '&agentAction=' + encodeURIComponent(agentAction);

        $.ajax({
            type: 'POST',
            url: '{% url "infrastructure" %}',
            data: formData,
            headers: {
                'X-CSRFToken': csrf_token
            },
            success: function (response) {
                $('#infrastructure-grid-form').html(response);
            }
        });
    }

    // Event handler for form submission
    //$(document).on('submit', '#infrastructure-grid-form', function (e) {
    //    e.preventDefault();
    //    submitGridForm();
    //});

    $(document).on('click', '#infrastructure-grid-form button', function (e) {
        e.preventDefault();
        submitGridForm($(this).attr('id'));
    });
</script>

{% endblock %}